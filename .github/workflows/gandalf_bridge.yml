name: Gandalf's Bridge v2.0 (Auto-Formatter)

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Target Branch'
        required: true
      commit_message:
        description: 'Commit Message'
        required: true
      files_json:
        description: 'Files to write (JSON)'
        required: true

jobs:
  bridge_update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.branch_name }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Auto-Formatters
        run: pip install autopep8

      - name: Write Files and Format
        run: |
          import json
          import os
          import subprocess

          files = json.loads('${{ github.event.inputs.files_json }}')
          for path, content in files.items():
              os.makedirs(os.path.dirname(path), exist_ok=True)
              with open(path, 'w') as f:
                  f.write(content)
              
              # Lisää automaattisesti tyhjä rivi loppuun ja korjaa PEP8
              subprocess.run(['autopep8', '--in-place', '--aggressive', path])
              
              # Varmista vielä kerran end-of-file rivinvaihto
              with open(path, 'a') as f:
                  f.write('\n')

        shell: python

     - name: Commit and Push
        run: |
          git config --global user.name "ipezygj"
          git config --global user.email "ipezygj@users.noreply.github.com"
          git add .
          # Käytetään dynaamista commit-viestiä, jossa on koodinimi 'Shadow-Protocol'
          git commit -m "${{ github.event.inputs.commit_message }} (SP-v2.1)"
          git push origin ${{ github.event.inputs.branch_name }}
