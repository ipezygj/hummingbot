name: Gandalfs Bridge 3.0

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch to work on (e.g., master, feat/hyperliquid, feat/orderly)'
        required: true
        default: 'master'
      create_new_branch:
        description: 'Create this branch if it does not exist? (true/false)'
        required: true
        default: 'false'
      commit_message:
        description: 'Commit Message (Professional format)'
        required: true
        default: 'refactor: technical update'
      files_json:
        description: 'JSON format: {"path": "content"}'
        required: true

jobs:
  bridge_update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Branch
        run: |
          git config --global user.name "Gandalfs Bridge"
          git config --global user.email "bridge@gandalf.ai"
          
          if [ "${{ github.event.inputs.create_new_branch }}" == "true" ]; then
            git checkout -b ${{ github.event.inputs.branch_name }}
          else
            git checkout ${{ github.event.inputs.branch_name }}
          fi

      - name: Update Multiple Files
        run: |
          echo '${{ github.event.inputs.files_json }}' > files.json
          python3 -c "
          import json, os
          with open('files.json') as f:
              data = json.load(f)
              for path, content in data.items():
                  os.makedirs(os.path.dirname(path), exist_ok=True)
                  with open(path, 'w') as out:
                      out.write(content)
          "
      
      - name: Commit and Push
        run: |
          git add .
          git commit -m "${{ github.event.inputs.commit_message }}"
          git push origin ${{ github.event.inputs.branch_name }}
