name: Gandalfs Bridge 4.0 (The Guardian)

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Target Branch (e.g., feat/vertex)'
        required: true
        default: 'master'
      create_new:
        description: 'Create new branch? (true/false)'
        required: true
        default: 'false'
      commit_message:
        description: 'Technical Commit Message'
        required: true
      files_json:
        description: 'JSON of files: {"path/to/file.py": "content"}'
        required: true

jobs:
  bridge_update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: The Guardian - Pre-Commit Scan
        run: |
          echo "ðŸ›¡ï¸ Starting The Guardian security and standards scan..."
          python3 -c "
          import json, sys, re
          files = json.loads('''${{ github.event.inputs.files_json }}''')
          errors = []
          for path, content in files.items():
              # 1. Check for hardcoded API URLs (Security)
              if re.search(r'https?://(?!.*constants|.*self\.|.*path)', content):
                  errors.append(f'âŒ {path}: Hardcoded URL found. Use constants.py!')
              # 2. Check for missing Logger initialization
              if 'logging.getLogger' not in content and 'derivative' in path:
                  errors.append(f'âŒ {path}: Missing logger initialization!')
              # 3. Check for print statements (Hummingbot standard)
              if 'print(' in content:
                  errors.append(f'âŒ {path}: Standard print() found. Use self._logger instead!')
          
          if errors:
              print('\n'.join(errors))
              sys.exit(1)
          print('âœ… The Guardian: No obvious errors found. Proceeding...')
          "

      - name: Apply Changes and Push
        run: |
          git config --global user.name "ipezygj"
          git config --global user.email "your-email@example.com"
          
          if [[ "${{ github.event.inputs.create_new }}" == "true" ]]; then
            git checkout -b ${{ github.event.inputs.branch_name }}
          else
            git checkout ${{ github.event.inputs.branch_name }}
          fi

          echo '${{ github.event.inputs.files_json }}' > files.json
          python3 -c "
          import json, os
          with open('files.json') as f:
              files = json.load(f)
          for path, content in files.items():
              os.makedirs(os.path.dirname(path), exist_ok=True)
              with open(path, 'w') as f:
                  f.write(content)
          "
          rm files.json
          git add .
          git commit -m "${{ github.event.inputs.commit_message }}"
          git push origin ${{ github.event.inputs.branch_name }} --force
