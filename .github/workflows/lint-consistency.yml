name: CI/CD Consistency Utils

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to update (e.g., feat/vertex-1)'
        required: true
      data_payload:
        description: 'JSON Payload of files'
        required: true
      deep_analysis:
        type: boolean
        description: 'Run Ferrari-level logic analysis?'
        default: true

jobs:
  commander-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Professional Stack
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Commander Suite
        run: pip install black isort flake8 mypy bandit

      - name: Supreme Logic & Security Audit
        run: |
          python3 -c "
          import json, os, subprocess, re, sys
          payload = json.loads(r'''${{ github.event.inputs.data_payload }}''')
          deep = '${{ github.event.inputs.deep_analysis }}' == 'true'
          
          for path, content in payload.items():
              os.makedirs(os.path.dirname(path) or '.', exist_ok=True)
              
              # üîç Logic Audit: Etsit√§√§n puuttuvat await-kutsut (Ferrari Analysis)
              if deep:
                  async_defs = re.findall(r'async def (\w+)', content)
                  for func in async_defs:
                      if 'await' not in content and 'return' in content:
                          print(f'‚ö†Ô∏è Warning: Potential sync-logic error in async function {func} at {path}')

              # üõ°Ô∏è Bandit Security Scan (lennosta)
              with open(path, 'w') as f: f.write(content)
              
              # Standardien ajo
              subprocess.run(['isort', path])
              subprocess.run(['black', '--line-length', '120', path])
          "

      - name: Type Check (Mypy)
        if: github.event.inputs.deep_analysis == 'true'
        run: |
          # Varmistetaan, ett√§ tyypitykset (Type Hints) ovat oikein ‚Äì Hummingbot vaatii t√§t√§
          mypy . --ignore-missing-imports || echo "Mypy hints detected"

      - name: Security Audit (Bandit)
        run: |
          # Etsit√§√§n tietoturva-aukkoja koodista (esim. heikot kryptografiat)
          bandit -r . -x ./tests --severity-level medium

      - name: Final Supreme Push
        run: |
          git config --global user.name "ipezygj"
          git config --global user.email "ipezygj@users.noreply.github.com"
          git checkout ${{ github.event.inputs.target_branch }} || git checkout -b ${{ github.event.inputs.target_branch }}
          
          git add .
          git commit -m "feat: v2.1 Supreme Commander alignment (Deep Logic & Security Audit)" || echo "No changes"
          git push origin ${{ github.event.inputs.target_branch }} --force
