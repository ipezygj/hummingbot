name: CI/CD Consistency Utils

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Target Branch (e.g., feat/vertex-1)'
        required: true
      is_patch:
        type: boolean
        description: 'Create new branch?'
        default: false
      files_json:
        description: 'Payload (JSON format)'
        required: true

jobs:
  maintenance:
    runs-on: ubuntu-latest
    steps:
      - name: Context Retrieval
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Environment Prep
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Linting Tools
        run: pip install autopep8 isort

      - name: Execute Consistency Guard
        run: |
          python3 -c "
          import json, os, subprocess, re, sys
          try:
              data = json.loads(r'''${{ github.event.inputs.files_json }}''')
              for path, content in data.items():
                  # üõ°Ô∏è The Guardian: Security Check
                  if re.search(r'https?://(?!.*constants|.*self\.|.*path)', content):
                      print(f'‚ùå Security Alert: Hardcoded URL in {path}')
                      sys.exit(1)
                  
                  # üõ†Ô∏è Apply Updates
                  os.makedirs(os.path.dirname(path) or '.', exist_ok=True)
                  with open(path, 'w') as f: f.write(content)
                  
                  # ‚ú® Polish: Auto-format and Sort imports
                  subprocess.run(['isort', path])
                  subprocess.run(['autopep8', '--in-place', '--aggressive', path])
                  print(f'‚úÖ Polished {path}')
          except Exception as e:
              print(f'‚ùå Error: {str(e)}')
              sys.exit(1)
          "

      - name: Commit & Sync
        run: |
          git config --global user.name "ipezygj"
          git config --global user.email "ipezygj@users.noreply.github.com"
          
          if [[ "${{ github.event.inputs.is_patch }}" == "true" ]]; then
            git checkout -b ${{ github.event.inputs.branch_name }}
          else
            git checkout ${{ github.event.inputs.branch_name }} || git checkout -b ${{ github.event.inputs.branch_name }}
          fi

          git add .
          git commit -m "refactor: technical alignment and linting for v2.1 standards" || echo "No changes to commit"
          git push origin ${{ github.event.inputs.branch_name }} --force
