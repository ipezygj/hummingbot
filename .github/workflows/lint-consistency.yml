name: CI/CD Consistency Utils

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to update (e.g., feat/vertex-1)'
        required: true
      sync_with_upstream:
        type: boolean
        description: 'Rebase with latest master before pushing?'
        default: true
      data_payload:
        description: 'JSON Payload of files'
        required: true

jobs:
  architect-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Local
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Tooling
        run: pip install autopep8 isort black

      - name: Upstream Sync (Optional)
        if: github.event.inputs.sync_with_upstream == 'true'
        run: |
          git remote add upstream https://github.com/hummingbot/hummingbot.git || true
          git fetch upstream master
          git checkout ${{ github.event.inputs.target_branch }}
          git rebase upstream/master || echo "Rebase skipped - local branch only"

      - name: Smart Polish & Guardian
        run: |
          python3 -c "
          import json, os, subprocess, sys
          payload = json.loads(r'''${{ github.event.inputs.data_payload }}''')
          for path, content in payload.items():
              os.makedirs(os.path.dirname(path) or '.', exist_ok=True)
              with open(path, 'w') as f: f.write(content)
              
              # ðŸ”¥ Multi-stage polishing
              subprocess.run(['isort', path])
              subprocess.run(['black', '--line-length', '120', path])
              subprocess.run(['autopep8', '--in-place', path])
              print(f'âœ¨ Optimized: {path}')
          "

      - name: Secure Push
        run: |
          git config --global user.name "ipezygj"
          git config --global user.email "ipezygj@users.noreply.github.com"
          git add .
          git commit -m "refactor: architectural alignment with v2.1 standards" || echo "No changes"
          git push origin ${{ github.event.inputs.target_branch }} --force
