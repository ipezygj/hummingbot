name: CI/CD Consistency Utils

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to update (e.g., feat/vertex-1)'
        required: true
      data_payload:
        description: 'JSON Payload of files'
        required: true
      apply_standards:
        type: boolean
        description: 'Run Black, isort & PEP8 polish?'
        default: true
      update_readme:
        type: boolean
        description: 'Audit README and Versioning?'
        default: true

jobs:
  supreme-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Local
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Tooling
        run: pip install black isort flake8

      - name: Smart Sync & Professional Polish
        run: |
          python3 -c "
          import json, os, subprocess, re
          payload = json.loads(r'''${{ github.event.inputs.data_payload }}''')
          apply_std = '${{ github.event.inputs.apply_standards }}' == 'true'
          
          summary = []
          for path, content in payload.items():
              os.makedirs(os.path.dirname(path) or '.', exist_ok=True)
              with open(path, 'w') as f: f.write(content)
              
              if apply_std:
                  subprocess.run(['isort', path])
                  subprocess.run(['black', '--line-length', '120', path])
                  summary.append(f'‚úÖ Polished: {path}')
              else:
                  summary.append(f'üìù Updated: {path}')

          # Tallennetaan yhteenveto lokiin
          with open('sync_summary.txt', 'w') as f:
              f.write('\n'.join(summary))
          "

      - name: Security & Quality Gate
        run: |
          echo "üõ°Ô∏è Running Flake8 quality checks..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Push & Log
        run: |
          git config --global user.name "ipezygj"
          git config --global user.email "ipezygj@users.noreply.github.com"
          git checkout ${{ github.event.inputs.target_branch }} || git checkout -b ${{ github.event.inputs.target_branch }}
          
          git add .
          # Luodaan tekninen commit-viesti, joka sis√§lt√§√§ tiedon automaattisesta tarkistuksesta
          git commit -m "refactor: technical alignment for v2.1 (automated polish & quality gate)" || echo "No changes"
          git push origin ${{ github.event.inputs.target_branch }} --force
          
          echo "üöÄ Sync complete! Summary:"
          cat sync_summary.txt
