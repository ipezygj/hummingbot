name: CI/CD Consistency Utils

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to update (e.g., feat/vertex-1)'
        required: true
      data_payload:
        description: 'JSON Payload of files'
        required: true
      dry_run:
        type: boolean
        description: 'Dry run? (Test without pushing)'
        default: false

jobs:
  supreme-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Local
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Professional Suite
        run: pip install black isort flake8

      - name: Smart Processing & Test Generation
        run: |
          python3 -c "
          import json, os, subprocess
          payload = json.loads(r'''${{ github.event.inputs.data_payload }}''')
          
          for path, content in payload.items():
              # 1. Create Directories
              os.makedirs(os.path.dirname(path) or '.', exist_ok=True)
              
              # 2. Write Content
              with open(path, 'w') as f: f.write(content)
              
              # 3. Automatic Test File Generation
              # Jos luot derivative.py -tiedoston, luodaan sille automaattisesti testipohja
              if 'derivative.py' in path:
                  test_path = path.replace('derivative.py', 'test_derivative.py')
                  if not os.path.exists(test_path):
                      with open(test_path, 'w') as tf:
                          tf.write('import unittest\nfrom .derivative import *\n\nclass TestDerivative(unittest.TestCase):\n    def test_logic(self):\n        pass')
                      print(f'ðŸ§ª Generated test scaffold: {test_path}')

              # 4. Linting
              subprocess.run(['isort', path])
              subprocess.run(['black', '--line-length', '120', path])
          "

      - name: Flake8 Quality Gate
        run: |
          # Tarkistetaan koodin laatu ennen pushausta
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Push to Branch
        if: github.event.inputs.dry_run == 'false'
        run: |
          git config --global user.name "ipezygj"
          git config --global user.email "ipezygj@users.noreply.github.com"
          git checkout ${{ github.event.inputs.target_branch }} || git checkout -b ${{ github.event.inputs.target_branch }}
          git add .
          git commit -m "feat: technical alignment and automated quality check" || echo "No changes"
          git push origin ${{ github.event.inputs.target_branch }} --force
