name: CI/CD Consistency Utils

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to update (e.g., feat/vertex-1)'
        required: true
      data_payload:
        description: 'JSON Payload of files'
        required: true
      update_readme:
        type: boolean
        description: 'Automatically audit README and Versioning?'
        default: true

jobs:
  supreme-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Local
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Tooling
        run: pip install black isort

      - name: Smart Sync & Documentation Audit
        run: |
          python3 -c "
          import json, os, re, subprocess
          payload = json.loads(r'''${{ github.event.inputs.data_payload }}''')
          update_docs = '${{ github.event.inputs.update_readme }}' == 'true'
          
          # 1. K√§sitell√§√§n koodimuutokset
          for path, content in payload.items():
              os.makedirs(os.path.dirname(path) or '.', exist_ok=True)
              with open(path, 'w') as f: f.write(content)
              subprocess.run(['isort', path])
              subprocess.run(['black', '--line-length', '120', path])

          # 2. The Documentor - README & Versioning
          if update_docs and os.path.exists('README.md'):
              with open('README.md', 'r') as f:
                  readme = f.read()
              
              # Etsit√§√§n p√∂rssin nimi payloadista (esim. vertex tai orderly)
              exchange = next((re.search(r'clob_perp/([^/]+)', p).group(1) for p in payload.keys() if 'clob_perp' in p), None)
              
              if exchange and exchange not in readme:
                  # Lis√§t√§√§n p√∂rssi listaan jos se puuttuu (t√§m√§ on yksinkertaistettu esimerkki)
                  print(f'üìù Adding {exchange} to documentation audit log...')
                  # T√§h√§n voisi lis√§t√§ monimutkaisempaa README-logiikkaa
          "

      - name: Push to Branch
        run: |
          git config --global user.name "ipezygj"
          git config --global user.email "ipezygj@users.noreply.github.com"
          git checkout ${{ github.event.inputs.target_branch }} || git checkout -b ${{ github.event.inputs.target_branch }}
          git add .
          git commit -m "feat: technical alignment, linting and documentation audit" || echo "No changes"
          git push origin ${{ github.event.inputs.target_branch }} --force
